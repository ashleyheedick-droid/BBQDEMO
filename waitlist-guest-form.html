<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Join Waitlist ‚Äì Smoke Sessions BBQ</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Open+Sans:wght@400;600&family=Playfair+Display:ital,wght@1,700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{--red:#E25822;--dark-red:#6B3000;--black:#0A0A0A;--dark-gray:#141414;--card:#1A1A1A;--light-gray:#CCCCCC;--white:#FFFFFF;--gold:#DAA520;--emerald:#10B981;--amber:#F59E0B}
body{font-family:'Open Sans',sans-serif;background:var(--black);color:var(--white);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;position:relative;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 30% 20%,rgba(226,88,34,.15),transparent 50%),radial-gradient(ellipse at 70% 80%,rgba(139,0,0,.1),transparent 50%);pointer-events:none}

.container{max-width:540px;width:100%}
.card{background:var(--card);border:2px solid rgba(226,88,34,.4);border-radius:20px;padding:40px 36px;box-shadow:0 20px 60px rgba(0,0,0,.6);position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--gold),var(--red),var(--gold))}

.header{text-align:center;margin-bottom:32px}
.logo{font-size:56px;display:block;margin-bottom:16px;filter:drop-shadow(0 6px 16px rgba(226,88,34,.4));animation:logoFloat 3s ease-in-out infinite}
@keyframes logoFloat{0%,100%{transform:translateY(0) rotate(-2deg)}50%{transform:translateY(-8px) rotate(2deg)}}
h1{font-family:'Montserrat',sans-serif;font-size:30px;font-weight:800;color:var(--red);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px}
.subtitle{font-size:14px;color:var(--light-gray);margin-bottom:4px}
.tagline{font-family:'Playfair Display',serif;font-style:italic;font-size:14px;color:var(--gold);margin-top:6px}

/* Live seafood button */
.seafood-btn-wrap{text-align:center;margin-top:20px}
.seafood-btn{display:inline-flex;align-items:center;gap:8px;padding:12px 22px;border:2px solid var(--red);border-radius:999px;background:linear-gradient(135deg,rgba(226,88,34,.15),rgba(139,0,0,.08));color:#ffe4b5;font-size:13px;font-weight:700;font-family:'Montserrat',sans-serif;letter-spacing:.04em;cursor:pointer;text-decoration:none;transition:all .25s ease;box-shadow:0 0 16px rgba(226,88,34,.2);animation:cajunPulse 2.5s ease-in-out infinite}
.seafood-btn:hover{background:linear-gradient(135deg,rgba(226,88,34,.3),rgba(139,0,0,.15));border-color:var(--gold);box-shadow:0 0 24px rgba(218,165,32,.25);transform:translateY(-3px);color:#fff}
.seafood-btn .dot{width:8px;height:8px;border-radius:50%;background:var(--emerald);box-shadow:0 0 8px var(--emerald);animation:dotBlink 1.4s ease-in-out infinite}
@keyframes cajunPulse{0%,100%{box-shadow:0 0 16px rgba(226,88,34,.2)}50%{box-shadow:0 0 24px rgba(226,88,34,.3)}}
@keyframes dotBlink{0%,100%{opacity:1}50%{opacity:.5}}

/* Form elements */
.form-group{margin-bottom:20px}
label{display:block;font-size:12px;font-weight:700;color:var(--light-gray);margin-bottom:8px;text-transform:uppercase;letter-spacing:.6px;font-family:'Montserrat',sans-serif}
.required{color:var(--red)}
input,textarea{width:100%;padding:14px 16px;background:var(--black);border:2px solid #2a2a2a;border-radius:10px;color:var(--white);font-size:15px;font-family:'Open Sans',sans-serif;transition:all 0.2s ease}
input::placeholder,textarea::placeholder{color:#555}
input:focus,textarea:focus{outline:none;border-color:var(--red);box-shadow:0 0 0 3px rgba(226,88,34,.15)}
textarea{min-height:80px;resize:vertical}

/* Party size selector */
.party-size-wrap{display:flex;gap:8px;flex-wrap:wrap}
.party-btn{width:48px;height:48px;border-radius:12px;border:2px solid #2a2a2a;background:var(--black);color:var(--light-gray);font-size:16px;font-weight:800;font-family:'Montserrat',sans-serif;cursor:pointer;transition:all .2s;display:grid;place-items:center}
.party-btn:hover{border-color:#555;background:rgba(255,255,255,.03)}
.party-btn.selected{border-color:var(--red);background:rgba(226,88,34,.15);color:var(--white);box-shadow:0 0 16px rgba(226,88,34,.2)}
.party-btn.custom{width:auto;padding:0 16px;font-size:13px;letter-spacing:.5px}

/* Spicy meter */
.spicy-meter{background:var(--black);border:2px solid #2a2a2a;border-radius:14px;padding:18px 16px;margin-bottom:20px}
.spicy-header{display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:14px;font-family:'Montserrat',sans-serif;font-size:13px;font-weight:700;color:var(--light-gray);text-transform:uppercase;letter-spacing:.5px}
.spicy-options{display:flex;gap:8px}
.spicy-opt{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;padding:12px 6px;border:2px solid #2a2a2a;border-radius:10px;background:transparent;cursor:pointer;transition:all .25s ease}
.spicy-opt:hover{border-color:#444;background:rgba(255,255,255,.02)}
.spicy-opt.selected{border-color:var(--red);background:rgba(226,88,34,.12);box-shadow:0 0 14px rgba(226,88,34,.18)}
.spicy-opt .fire{font-size:22px;line-height:1;min-height:28px;display:flex;align-items:center;justify-content:center}
.spicy-opt .fire-label{font-size:11px;font-weight:700;font-family:'Montserrat',sans-serif;color:var(--light-gray);text-transform:uppercase;letter-spacing:.3px;text-align:center;line-height:1.2}
.spicy-opt.selected .fire-label{color:var(--white)}
.no-spice-dot{width:12px;height:12px;border-radius:50%;background:var(--red);box-shadow:0 0 6px rgba(226,88,34,.5)}
.spicy-opt.selected .fire{animation:fireWiggle .4s ease}
@keyframes fireWiggle{0%{transform:scale(1)}30%{transform:scale(1.25) rotate(-5deg)}60%{transform:scale(1.15) rotate(3deg)}100%{transform:scale(1)}}

/* Seafood preference & allergy section */
.pref-section{background:var(--black);border:2px solid #2a2a2a;border-radius:14px;padding:18px 16px;margin-bottom:20px}
.pref-header{display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:14px;font-family:'Montserrat',sans-serif;font-size:13px;font-weight:700;color:var(--light-gray);text-transform:uppercase;letter-spacing:.5px}
.pref-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.pref-item{display:flex;flex-direction:column;align-items:center;gap:6px;padding:12px 6px;border:2px solid #2a2a2a;border-radius:10px;background:transparent;cursor:pointer;transition:all .25s ease}
.pref-item:hover{border-color:#444;background:rgba(255,255,255,.02)}
.pref-item.selected{border-color:var(--gold);background:rgba(218,165,32,.08);box-shadow:0 0 12px rgba(218,165,32,.15)}
.pref-item .pref-icon{font-size:24px}
.pref-item .pref-label{font-size:10px;font-weight:700;font-family:'Montserrat',sans-serif;color:var(--light-gray);text-transform:uppercase;letter-spacing:.3px;text-align:center;line-height:1.2}
.pref-item.selected .pref-label{color:var(--gold)}

/* Allergy tags */
.allergy-section{background:var(--black);border:2px solid #2a2a2a;border-radius:14px;padding:18px 16px;margin-bottom:20px}
.allergy-header{display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:12px;font-family:'Montserrat',sans-serif;font-size:13px;font-weight:700;color:var(--light-gray);text-transform:uppercase;letter-spacing:.5px}
.allergy-tags{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.allergy-tag{padding:8px 14px;border-radius:999px;border:2px solid #2a2a2a;background:transparent;color:var(--light-gray);font-size:12px;font-weight:700;font-family:'Montserrat',sans-serif;cursor:pointer;transition:all .2s;letter-spacing:.3px}
.allergy-tag:hover{border-color:#555;background:rgba(255,255,255,.03)}
.allergy-tag.selected{border-color:var(--amber);background:rgba(245,158,11,.1);color:var(--amber);box-shadow:0 0 12px rgba(245,158,11,.15)}

/* Consent */
.consent-box{background:var(--black);border:2px solid #2a2a2a;border-radius:10px;padding:16px;margin-bottom:20px}
.checkbox-item{display:flex;align-items:flex-start;gap:12px;margin-bottom:12px}
.checkbox-item:last-child{margin-bottom:0}
.checkbox-item input[type="checkbox"]{width:20px;height:20px;margin-top:2px;cursor:pointer;flex-shrink:0;accent-color:var(--red)}
.checkbox-label{font-size:13px;color:var(--light-gray);line-height:1.6;cursor:pointer}
.checkbox-label strong{color:var(--white)}

/* Submit button */
.submit-btn{width:100%;padding:16px 24px;background:linear-gradient(135deg,var(--red),var(--dark-red));border:none;border-radius:12px;color:var(--white);font-size:16px;font-weight:800;font-family:'Montserrat',sans-serif;text-transform:uppercase;cursor:pointer;transition:all 0.25s ease;letter-spacing:.5px;box-shadow:0 8px 24px rgba(226,88,34,.3),0 0 0 2px var(--gold)}
.submit-btn:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 12px 32px rgba(226,88,34,.4),0 0 0 2px var(--gold),0 0 20px rgba(218,165,32,.15)}
.submit-btn:disabled{opacity:.5;cursor:not-allowed}

.status-message{display:none;margin-top:16px;padding:14px 16px;border-radius:10px;font-size:14px;font-weight:600}
.status-message.show{display:block}
.status-message.error{background:rgba(226,88,34,.12);border:2px solid rgba(226,88,34,.3);color:#ff6b6b}
.status-message.success{background:rgba(16,185,129,.1);border:2px solid rgba(16,185,129,.3);color:#4ade80}

/* Success view */
.success-view{display:none;text-align:center;padding:20px 0}
.success-view.show{display:block}
.success-icon{font-size:72px;display:block;margin-bottom:20px;animation:popIn .5s cubic-bezier(.34,1.56,.64,1)}
@keyframes popIn{0%{transform:scale(0)}100%{transform:scale(1)}}
.success-view h2{font-family:'Montserrat',sans-serif;font-size:26px;font-weight:800;color:var(--red);margin-bottom:12px}
.success-view p{color:var(--light-gray);font-size:15px;margin-bottom:24px;line-height:1.6}
.wait-time-box{background:var(--black);border:2px solid var(--red);border-radius:14px;padding:24px;margin-bottom:24px}
.wait-time-label{font-size:12px;color:var(--light-gray);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;font-family:'Montserrat',sans-serif;font-weight:700}
.wait-time-value{font-family:'Montserrat',sans-serif;font-size:36px;font-weight:800;color:var(--red)}
.parties-ahead{font-size:14px;color:var(--light-gray);margin-top:12px}
.success-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
.back-btn{padding:12px 24px;background:var(--black);border:2px solid var(--red);border-radius:10px;color:var(--white);font-size:14px;font-weight:700;cursor:pointer;transition:all 0.2s ease;text-decoration:none;display:inline-flex;align-items:center;gap:6px;font-family:'Montserrat',sans-serif}
.back-btn:hover{background:rgba(226,88,34,.1);transform:translateY(-2px)}
.back-btn.seafood{border-color:var(--gold);color:var(--gold)}
.back-btn.seafood:hover{background:rgba(218,165,32,.08)}

@media(max-width:600px){
  .card{padding:28px 20px;border-radius:16px}
  h1{font-size:26px}
  .pref-grid{grid-template-columns:repeat(3,1fr);gap:6px}
  .party-size-wrap{justify-content:center}
}
</style>
</head>
<body>
<div class="container">
  <div class="card">

    <div id="formView">
      <div class="header">
        <span class="logo">ü•©</span>
        <h1>Join Waitlist</h1>
        <p class="subtitle">We'll notify you when your table is ready</p>
        <div class="tagline">"Low & Slow, That's How We Roll"</div>
        <div class="seafood-btn-wrap">
          <a href="live-update-inventory.html" class="seafood-btn">
            <span class="dot"></span>
            ü•© See Live Smoker Status üî•
          </a>
        </div>
      </div>

      <div class="form-group">
        <label>Name <span class="required">*</span></label>
        <input type="text" id="name" required placeholder="John Smith" autocomplete="name" />
      </div>
      <div class="form-group">
        <label>Phone Number <span class="required">*</span></label>
        <input type="tel" id="phone" required placeholder="(469) 555-1234" autocomplete="tel" />
      </div>

      <div class="form-group">
        <label>Party Size <span class="required">*</span></label>
        <div class="party-size-wrap" id="partyButtons">
          <button type="button" class="party-btn" data-size="1">1</button>
          <button type="button" class="party-btn selected" data-size="2">2</button>
          <button type="button" class="party-btn" data-size="3">3</button>
          <button type="button" class="party-btn" data-size="4">4</button>
          <button type="button" class="party-btn" data-size="5">5</button>
          <button type="button" class="party-btn" data-size="6">6</button>
          <button type="button" class="party-btn custom" data-size="custom">7+</button>
        </div>
        <input type="number" id="partySize" value="2" min="1" max="20" style="display:none;margin-top:10px" placeholder="Enter party size" />
      </div>

      <!-- Meat Preferences -->
      <div class="pref-section">
        <div class="pref-header">ü•© What Meat Are You Craving? (Optional)</div>
        <div class="pref-grid" id="prefGrid">
          <button type="button" class="pref-item" data-pref="Brisket">
            <span class="pref-icon">ü•©</span>
            <span class="pref-label">Brisket</span>
          </button>
          <button type="button" class="pref-item" data-pref="Ribs">
            <span class="pref-icon">üçñ</span>
            <span class="pref-label">Ribs</span>
          </button>
          <button type="button" class="pref-item" data-pref="Pulled Pork">
            <span class="pref-icon">üê∑</span>
            <span class="pref-label">Pulled Pork</span>
          </button>
          <button type="button" class="pref-item" data-pref="Sausage">
            <span class="pref-icon">üå≠</span>
            <span class="pref-label">Sausage</span>
          </button>
          <button type="button" class="pref-item" data-pref="Turkey">
            <span class="pref-icon">ü¶É</span>
            <span class="pref-label">Turkey</span>
          </button>
          <button type="button" class="pref-item" data-pref="Sides Only">
            <span class="pref-icon">ü•ó</span>
            <span class="pref-label">Sides Only</span>
          </button>
        </div>
      </div>

      <!-- Allergy Tags -->
      <div class="allergy-section">
        <div class="allergy-header">‚öïÔ∏è Any Allergies? (Optional)</div>
        <div class="allergy-tags" id="allergyTags">
          <button type="button" class="allergy-tag" data-allergy="Shellfish">Shellfish</button>
          <button type="button" class="allergy-tag" data-allergy="Gluten">Gluten</button>
          <button type="button" class="allergy-tag" data-allergy="Dairy">Dairy</button>
          <button type="button" class="allergy-tag" data-allergy="Nuts">Nuts</button>
          <button type="button" class="allergy-tag" data-allergy="Soy">Soy</button>
          <button type="button" class="allergy-tag" data-allergy="None">None</button>
        </div>
      </div>

      <div class="spicy-meter">
        <div class="spicy-header">üí® How Hot Do You Like It? üí®</div>
        <div class="spicy-options" id="spicyOptions">
          <button type="button" class="spicy-opt selected" data-level="No Spice">
            <span class="fire"><span class="no-spice-dot"></span></span>
            <span class="fire-label">No<br>Spice</span>
          </button>
          <button type="button" class="spicy-opt" data-level="Mild">
            <span class="fire">üî•</span>
            <span class="fire-label">Mild</span>
          </button>
          <button type="button" class="spicy-opt" data-level="Spicy">
            <span class="fire">üî•üî•</span>
            <span class="fire-label">Spicy</span>
          </button>
          <button type="button" class="spicy-opt" data-level="Turbo Hot">
            <span class="fire">üî•üî•üî•</span>
            <span class="fire-label">Turbo<br>Hot</span>
          </button>
        </div>
      </div>

      <div class="form-group">
        <label>Special Requests (Optional)</label>
        <textarea id="notes" placeholder="Birthday celebration, booth seating, high chair needed..."></textarea>
      </div>

      <div class="consent-box">
        <div class="checkbox-item">
          <input type="checkbox" id="smsConsent">
          <label for="smsConsent" class="checkbox-label">
            <span class="required">*</span> <strong>I agree to receive text messages</strong> about my waitlist status. Reply STOP to opt out.
          </label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="marketingOptIn">
          <label for="marketingOptIn" class="checkbox-label">
            Send me fresh catch alerts and specials (optional)
          </label>
        </div>
      </div>

      <button type="button" class="submit-btn" id="submitBtn">Join Waitlist</button>
      <div class="status-message" id="statusMessage"></div>
    </div>

    <div class="success-view" id="successView">
      <span class="success-icon">üéâ</span>
      <h2>You're on the list!</h2>
      <p>We'll send you a text when your table is ready. While you wait, check out today's smoked meats!</p>
      <div class="wait-time-box">
        <div class="wait-time-label">Estimated Wait Time</div>
        <div class="wait-time-value" id="estimatedWait">Calculating...</div>
        <div class="parties-ahead" id="partiesAhead"></div>
      </div>
      <div class="success-actions">
        <a href="live-update-inventory.html" class="back-btn seafood">ü•© View Smoker Status</a>
        <a href="pit-ai-chat.html" class="back-btn">ü§ñ Ask AI Concierge</a>
      </div>
    </div>

  </div>
</div>

<script>
const APPS = localStorage.getItem('appsScriptUrl') || "";

// ‚îÄ‚îÄ JSONP helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function jsonpGet(params) {
  return new Promise((resolve, reject) => {
    if (!APPS) { reject(new Error('Apps Script URL not configured.')); return; }
    const cb  = 'jcb_' + Math.random().toString(36).slice(2);
    const qs  = new URLSearchParams({ ...params, callback: cb }).toString();
    const s   = document.createElement('script');
    s.src     = APPS + '?' + qs;
    const timer = setTimeout(() => { cleanup(); reject(new Error('Request timed out')); }, 10000);
    window[cb] = (data) => { clearTimeout(timer); cleanup(); resolve(data); };
    s.onerror  = () => { clearTimeout(timer); cleanup(); reject(new Error('Network error')); };
    function cleanup() { delete window[cb]; if (s.parentNode) s.parentNode.removeChild(s); }
    document.body.appendChild(s);
  });
}

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let selectedSpice = 'No Spice';
let selectedPartySize = 2;
let selectedPrefs = [];
let selectedAllergies = [];

// ‚îÄ‚îÄ Spicy meter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('spicyOptions').addEventListener('click', e => {
  const opt = e.target.closest('.spicy-opt');
  if (!opt) return;
  document.querySelectorAll('.spicy-opt').forEach(o => o.classList.remove('selected'));
  opt.classList.add('selected');
  selectedSpice = opt.dataset.level;
});

// ‚îÄ‚îÄ Party size buttons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('partyButtons').addEventListener('click', e => {
  const btn = e.target.closest('.party-btn');
  if (!btn) return;
  document.querySelectorAll('.party-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');

  const sizeInput = document.getElementById('partySize');
  if (btn.dataset.size === 'custom') {
    sizeInput.style.display = 'block';
    sizeInput.focus();
    selectedPartySize = parseInt(sizeInput.value) || 7;
  } else {
    sizeInput.style.display = 'none';
    selectedPartySize = parseInt(btn.dataset.size);
    sizeInput.value = selectedPartySize;
  }
});

document.getElementById('partySize').addEventListener('input', e => {
  selectedPartySize = parseInt(e.target.value) || 1;
});

// ‚îÄ‚îÄ Seafood preference grid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('prefGrid').addEventListener('click', e => {
  const item = e.target.closest('.pref-item');
  if (!item) return;
  item.classList.toggle('selected');
  const pref = item.dataset.pref;
  if (item.classList.contains('selected')) {
    if (!selectedPrefs.includes(pref)) selectedPrefs.push(pref);
  } else {
    selectedPrefs = selectedPrefs.filter(p => p !== pref);
  }
});

// ‚îÄ‚îÄ Allergy tags ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('allergyTags').addEventListener('click', e => {
  const tag = e.target.closest('.allergy-tag');
  if (!tag) return;

  if (tag.dataset.allergy === 'None') {
    // Deselect all others, select None
    document.querySelectorAll('.allergy-tag').forEach(t => t.classList.remove('selected'));
    tag.classList.add('selected');
    selectedAllergies = ['None'];
  } else {
    // Deselect "None" if another allergy is selected
    document.querySelector('.allergy-tag[data-allergy="None"]').classList.remove('selected');
    tag.classList.toggle('selected');
    selectedAllergies = selectedAllergies.filter(a => a !== 'None');
    const allergy = tag.dataset.allergy;
    if (tag.classList.contains('selected')) {
      if (!selectedAllergies.includes(allergy)) selectedAllergies.push(allergy);
    } else {
      selectedAllergies = selectedAllergies.filter(a => a !== allergy);
    }
  }
});

// ‚îÄ‚îÄ Status helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const statusMsg = document.getElementById('statusMessage');
function showStatus(msg, type) { statusMsg.textContent = msg; statusMsg.className = 'status-message show ' + type; }
function hideStatus() { statusMsg.className = 'status-message'; }

// ‚îÄ‚îÄ Phone formatter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('phone').addEventListener('input', e => {
  let v = e.target.value.replace(/\D/g, '');
  if (v.length <= 3)      v = v.length ? `(${v}` : '';
  else if (v.length <= 6) v = `(${v.slice(0,3)}) ${v.slice(3)}`;
  else                    v = `(${v.slice(0,3)}) ${v.slice(3,6)}-${v.slice(6,10)}`;
  e.target.value = v;
});

// ‚îÄ‚îÄ Calculate estimated wait ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calcWait(ahead) {
  if (ahead <= 2)  return { time: '5-15 min',  msg: `${ahead} ${ahead===1?'party':'parties'} ahead of you` };
  if (ahead <= 4)  return { time: '15-25 min', msg: `${ahead} parties ahead of you` };
  if (ahead <= 6)  return { time: '30-40 min', msg: `${ahead} parties ahead of you` };
  return               { time: '45-60 min', msg: `${ahead} parties ahead of you` };
}

// ‚îÄ‚îÄ Submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('submitBtn').addEventListener('click', async () => {
  hideStatus();

  const name       = document.getElementById('name').value.trim();
  const phoneRaw   = document.getElementById('phone').value.trim();
  const phone      = phoneRaw.replace(/\D/g, '');
  const partySize  = selectedPartySize;
  const notes      = document.getElementById('notes').value.trim();
  const smsConsent = document.getElementById('smsConsent').checked;
  const marketing  = document.getElementById('marketingOptIn').checked;

  if (!name || !phone)                  { showStatus('Please fill out your name and phone number', 'error'); return; }
  if (phone.length < 10)               { showStatus('Please enter a valid 10-digit phone number', 'error'); return; }
  if (!smsConsent)                      { showStatus('You must agree to receive text messages', 'error'); return; }

  const btn = document.getElementById('submitBtn');
  btn.disabled = true;
  btn.textContent = 'Adding you to the list...';

  try {
    let partiesAhead = 0;
    try {
      const wl = await jsonpGet({ action: 'getWaitlist' });
      if (wl.success && wl.data) {
        partiesAhead = wl.data.filter(p => {
          const s = (p.status || '').trim().toLowerCase();
          return s === 'waiting' || s === 'notified';
        }).length;
      }
    } catch (e) { /* non-fatal */ }

    // Build special notes with preferences and allergies
    let fullNotes = notes;
    if (selectedPrefs.length > 0) {
      fullNotes += (fullNotes ? ' | ' : '') + 'Craving: ' + selectedPrefs.join(', ');
    }
    if (selectedAllergies.length > 0 && selectedAllergies[0] !== 'None') {
      fullNotes += (fullNotes ? ' | ' : '') + 'ALLERGIES: ' + selectedAllergies.join(', ');
    }

    const result = await jsonpGet({
      action:         'addToWaitlist',
      name:           name,
      phone:          phone,
      partySize:      String(partySize),
      specialNotes:   fullNotes,
      spiceLevel:     selectedSpice,
      smsConsent:     'Yes',
      marketingOptIn: marketing ? 'Yes' : 'No'
    });

    if (!result.success) throw new Error(result.error || 'Failed to add to waitlist');

    document.getElementById('formView').style.display = 'none';
    const sv = document.getElementById('successView');
    sv.classList.add('show');
    const est = calcWait(partiesAhead);
    document.getElementById('estimatedWait').textContent = est.time;
    document.getElementById('partiesAhead').textContent  = est.msg;

  } catch (err) {
    showStatus(err.message, 'error');
    btn.disabled = false;
    btn.textContent = 'Join Waitlist';
  }
});
</script>
</body>
</html>
